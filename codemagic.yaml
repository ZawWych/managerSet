workflows:
  build-flet-apk:
    name: Build Flet Android APK
    max_build_duration: 120
    environment:
      groups:
        - android_signing
      flutter: "3.22.2"
    scripts:
      - name: Install Python & Dependencies
        script: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          
          echo "üîÑ –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Flet –≤–µ—Ä—Å–∏–∏ 0.22.1..."
          pip install flet==0.22.1 requests==2.31.0 gspread==6.0.0 google-auth==2.23.4 google-api-python-client==2.108.0 || (
            echo "‚ùå Flet 0.22.1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º 0.23.1..."
            pip install flet==0.23.1 requests==2.31.0 gspread==6.0.0 google-auth==2.23.4 google-api-python-client==2.108.0 || (
              echo "‚ùå Flet 0.23.1 –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º 0.24.1..."
              pip install flet==0.24.1 requests==2.31.0 gspread==6.0.0 google-auth==2.23.4 google-api-python-client==2.108.0 || (
                echo "‚ùå –í—Å–µ –≤–µ—Ä—Å–∏–∏ Flet –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –ø—Ä–æ–±—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é..."
                pip install flet requests==2.31.0 gspread==6.0.0 google-auth==2.23.4 google-api-python-client==2.108.0
              )
            )
          )
          echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      - name: Accept Android licenses
        script: |
          echo "–ü—Ä–∏–Ω–∏–º–∞–µ–º Android –ª–∏—Ü–µ–Ω–∑–∏–∏..."
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–∏–Ω—è—Ç–∏—è –ª–∏—Ü–µ–Ω–∑–∏–π
          flutter doctor --android-licenses || \
          $ANDROID_HOME/tools/bin/sdkmanager --licenses || \
          echo "–õ–∏—Ü–µ–Ω–∑–∏–∏ –ø—Ä–∏–Ω—è—Ç—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º"

      - name: Build APK
        script: |
          source .venv/bin/activate
          flet build apk --verbose

      - name: Rename APK
        script: |
          APK_PATH=$(find build -name "*.apk" | head -n 1)
          if [ -n "$APK_PATH" ]; then
            mv "$APK_PATH" "Set_Manager.apk"
            echo "‚úÖ APK —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: Set_Manager.apk"
          else
            echo "‚ùå APK file not found!"
            find build -type f
            exit 1
          fi

    artifacts:
      - "*.apk"